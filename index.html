<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Primera Comunión</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&family=Parisienne&display=swap" rel="stylesheet" />

  <style>
    :root {
        /* --- Paleta Original --- */
        --bg: #f9f5f1;
        --card-bg: #ffffff;
        --muted: #f0e6d6;
        --accent: #8e6c88;
        --accent-2: rgba(142, 108, 136, 0.9);
        --map-btn: rgba(107, 142, 122, 0.9);
        --text: #444444;
        --muted-text: #777777;
        --shadow: rgba(0, 0, 0, 0.10);
        --focus-ring: rgba(142, 108, 136, 0.25);
        --error: #d32f2f;
        --warning: #f57c00;
        --success: #388e3c;

        /* --- UI Variables --- */
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;
        --radius-pill: 50px;
        --shadow-sm: 0 4px 12px rgba(142, 108, 136, 0.06);
        --shadow-md: 0 10px 30px rgba(142, 108, 136, 0.10);
        --shadow-lg: 0 20px 50px rgba(142, 108, 136, 0.15);
        --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        --max-width: 800px;
    }

    /* Reset & Base */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { scroll-behavior: smooth; height: 100%; }
    
    body {
        margin: 0;
        font-family: 'Montserrat', system-ui, -apple-system, sans-serif;
        background-color: var(--bg);
        background-image: 
            radial-gradient(circle at 0% 0%, rgba(142, 108, 136, 0.03) 0%, transparent 40%),
            radial-gradient(circle at 100% 100%, rgba(107, 142, 122, 0.03) 0%, transparent 40%);
        color: var(--text);
        line-height: 1.6;
    }

    /* --- Contenedor Principal --- */
    .invitation-container {
        max-width: var(--max-width);
        margin: 0 auto;
        min-height: 100vh;
        background: var(--card-bg);
        box-shadow: 0 0 60px rgba(0,0,0,0.02);
        position: relative;
        overflow: hidden;
    }

    /* --- Decoraciones de Fondo --- */
    .decoration { position: absolute; z-index: 0; pointer-events: none; }
    .decoration.circle {
        width: 180px; height: 180px; border: 1px solid var(--accent);
        border-radius: 50%; top: -20px; right: -40px; opacity: 0.08;
    }
    .decoration.flower {
        width: 120px; height: 120px;
        background-image: radial-gradient(var(--accent) 15%, transparent 16%);
        background-size: 20px 20px; bottom: 5%; left: -2%;
        opacity: 0.05; transform: rotate(15deg);
    }

    /* --- Header --- */
    header {
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0,0,0,0.03) !important;
    }
    .logo-link { text-decoration: none; transition: opacity 0.2s; }
    .logo-link:hover { opacity: 0.8; }

    /* --- Sección Hero --- */
    .header-section {
        padding: 50px 20px 20px;
        background: radial-gradient(circle at center top, #fffcf9, var(--bg));
        text-align: center; display: flex; flex-direction: column; align-items: center;
    }
    .header-section::before, .invitation-heading::after, .child-name::after { display: none; }

    .invitation-heading {
        font-size: 11px; letter-spacing: 3px; font-weight: 600; text-transform: uppercase;
        color: var(--muted-text); margin-bottom: 15px; border-bottom: 1px solid var(--accent);
        padding-bottom: 5px; display: inline-block;
    }

    .event-title .first-word {
        font-family: 'Parisienne', cursive; font-size: clamp(48px, 9vw, 76px);
        color: var(--accent); line-height: 1; text-shadow: 2px 2px 0px rgba(240, 230, 214, 0.4);
        margin-bottom: 5px; display: block; animation: fadeInUp 0.8s ease-out;
    }
    .event-title .second-word { display: none; }

    .communion-image {
        width: 100%; max-width: 300px; aspect-ratio: 3/4; object-fit: cover;
        margin: 30px auto; border-radius: 150px 150px 10px 10px;
        box-shadow: var(--shadow-md); border: 4px solid #fff; display: block;
    }

    .child-name {
        font-family: 'Playfair Display', serif; font-weight: 700; font-size: clamp(28px, 6vw, 42px);
        color: var(--accent); margin: 10px 0 20px; line-height: 1.2;
        animation: fadeInUp 0.8s ease-out 0.3s both;
    }

    /* --- Detalles del Evento (Centrado) --- */
    .content-section {
        padding: 10px 20px 60px; display: flex; flex-direction: column;
        align-items: center; width: 100%; animation: fadeIn 1s ease-out 0.5s both;
    }

    .event-date {
        font-family: 'Montserrat', sans-serif; font-size: 13px; letter-spacing: 2px;
        text-transform: uppercase; color: var(--accent); background: #fff;
        border: 1px solid var(--muted); border-radius: var(--radius-pill);
        padding: 12px 36px; margin-bottom: 40px; box-shadow: var(--shadow-sm);
        font-weight: 600; text-align: center; width: auto;
    }

    /* --- Tarjetas --- */
    .event-card {
        background: #fff; border: 1px solid #f2f2f2; border-radius: var(--radius-md);
        padding: 30px 20px; margin-bottom: 24px; width: 100%; max-width: 480px;
        box-shadow: var(--shadow-sm); transition: transform 0.3s var(--ease-smooth), box-shadow 0.3s var(--ease-smooth);
        text-align: center; position: relative;
    }
    .event-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
    .event-card::before, .event-type::after { display: none; }

    .event-type {
        font-family: 'Playfair Display', serif; font-size: 22px; color: var(--accent);
        margin-bottom: 10px; font-weight: 700; display: flex; flex-direction: column;
        align-items: center; gap: 8px;
    }

    /* Iconografía CSS Mask */
    .event-type::before {
        content: ''; display: block; width: 28px; height: 28px;
        background-color: var(--accent); -webkit-mask-size: contain; mask-size: contain;
        -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        -webkit-mask-position: center; mask-position: center; opacity: 0.9;
    }

    /* Iconos Específicos */
    [aria-labelledby="ceremonia"] .event-type::before {
        -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 22v-8.2a2 2 0 0 0-1.1-1.8l-4-1.8a2 2 0 0 0-1.8 0l-4 1.8A2 2 0 0 0 6 13.8V22'/%3E%3Cpath d='M12 2v6'/%3E%3Cpath d='M10 5h4'/%3E%3Cpath d='M12 22v-5'/%3E%3C/svg%3E");
    }
    [aria-labelledby="recepcion"] .event-type::before {
        -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M8 22h8'/%3E%3Cpath d='M12 15v7'/%3E%3Cpath d='M17 10a5 5 0 0 0-10 0'/%3E%3Cpath d='M12 15a5 5 0 0 0 5-5'/%3E%3Cpath d='M7 10a5 5 0 0 0 5 5'/%3E%3Cpath d='M9 2a3 3 0 0 1 3 3v2'/%3E%3Cpath d='M15 2a3 3 0 0 0-3 3'/%3E%3C/svg%3E");
    }
    [aria-labelledby="regalos"] .event-type::before {
        -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='8' width='18' height='4' rx='1'/%3E%3Cpath d='M12 8v13'/%3E%3Cpath d='M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7'/%3E%3Cpath d='M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5'/%3E%3C/svg%3E");
    }

    .event-time {
        font-size: 13px; font-weight: 600; text-transform: uppercase;
        color: var(--map-btn); letter-spacing: 1px; margin-bottom: 8px;
    }
    .event-location {
        font-size: 14px; line-height: 1.5; color: var(--muted-text);
        margin-bottom: 20px; white-space: pre-line;
    }

    /* Botones Secundarios */
    .map-button, .gift-button {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 10px 24px; font-size: 12px; font-weight: 600; text-transform: uppercase;
        border-radius: var(--radius-pill); background: transparent; color: var(--map-btn);
        border: 1px solid var(--map-btn); text-decoration: none; transition: all 0.2s ease;
    }
    .map-button:hover, .gift-button:hover { background: var(--map-btn); color: #fff; }

    /* Botón Confirmar Principal */
    .confirm-button {
        display: inline-block; background: var(--accent); color: #ffffff;
        font-family: 'Montserrat', sans-serif; font-size: 15px; font-weight: 600;
        letter-spacing: 1px; text-transform: uppercase; padding: 16px 48px;
        border-radius: var(--radius-pill); border: none; cursor: pointer;
        box-shadow: 0 8px 20px rgba(142, 108, 136, 0.35); transition: all 0.3s var(--ease-smooth);
        margin-top: 20px; width: auto; min-width: 250px; text-align: center;
    }
    .confirm-button:hover {
        transform: translateY(-2px) scale(1.02); background: var(--accent-2);
        box-shadow: 0 12px 25px rgba(142, 108, 136, 0.45);
    }
    .map-button::before, .confirm-button::before, .gift-button::before { display: none; }

    /* --- FOOTER DISEÑO ADAPTADO (Referencia Imagen) --- */
    footer {
        background: var(--bg); /* Fondo suave beige/crema */
        padding: 40px 20px 30px;
        border-top: 1px solid rgba(0,0,0,0.05); /* Separación sutil */
        margin-top: 0;
    }

    .footer-promo {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid rgba(0,0,0,0.05); /* Línea divisoria */
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .footer-promo p {
        color: var(--muted-text);
        font-size: 14px;
        margin-bottom: 20px;
    }

    /* Botón Outline Footer */
    .btn-cotizar {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 35px;
        border: 1px solid var(--accent);
        border-radius: 50px; /* Borde ovalado completo */
        color: var(--accent);
        text-decoration: none;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        transition: all 0.3s ease;
        background: transparent; /* Fondo transparente */
    }

    .btn-cotizar:hover {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 4px 15px rgba(142, 108, 136, 0.2);
    }

    /* Copyright a la derecha */
    .footer-copyright {
        text-align: right;
        font-size: 11px;
        color: #999;
        line-height: 1.6;
        max-width: var(--max-width);
        margin: 0 auto;
    }
    
    .footer-copyright a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 500;
    }

    /* Responsividad Footer */
    @media (max-width: 600px) {
        .footer-copyright { text-align: center; } /* Centrado en móviles */
    }

    /* --- Modal --- */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(40,35,40,0.5); backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 999;
    }
    .modal.active { opacity: 1; pointer-events: all; }
    
    .modal-content {
        background: #fff; width: 90%; max-width: 400px; padding: 30px;
        border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
        transform: translateY(20px); transition: transform 0.3s;
        max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal.active .modal-content { transform: translateY(0); }
    
    .close-modal {
        position: absolute; top: 15px; right: 15px; background: transparent;
        border: none; font-size: 24px; color: var(--text); cursor: pointer;
    }
    
    .modal-title {
        font-family: 'Playfair Display', serif; font-size: 24px; color: var(--accent);
        text-align: center; margin-bottom: 20px;
    }
    
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-label { display: block; font-size: 12px; font-weight: 700; color: var(--muted-text); margin-bottom: 5px; text-transform: uppercase; }
    
    input {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        font-size: 14px; outline: none; transition: border 0.2s;
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--focus-ring); }
    input.error { border-color: var(--error); background: #fffcfc; }
    
    .error-message, .warning-message { font-size: 11px; margin-top: 4px; display: none; }
    .error-message { color: var(--error); }
    .warning-message { color: var(--warning); }
    
    .submit-btn {
        width: 100%; padding: 14px; background: var(--accent); color: #fff;
        border: none; border-radius: var(--radius-pill); font-weight: 600;
        margin-top: 10px; cursor: pointer; text-transform: uppercase; font-size: 13px; letter-spacing: 1px;
    }
    .submit-btn:hover:not(:disabled) { background: var(--accent-2); }
    .submit-btn:disabled { opacity: 0.7; }
    
    .loading-spinner {
        display: none; width: 24px; height: 24px; margin: 10px auto;
        border: 2px solid rgba(142,108,136,0.2); border-top-color: var(--accent);
        border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .success { 
        text-align: center; color: var(--success); font-family: 'Parisienne', cursive; font-size: 24px; display: none; margin-top: 15px; 
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    @media(max-width: 480px){
        .child-name { font-size: 32px; }
        .event-card { padding: 25px 15px; }
    }
  </style>
</head>
<body>
  <div class="decoration circle"></div>
  <div class="decoration flower"></div>

  <header style="position:sticky;top:0;z-index:60;background:rgba(255,255,255,0.9);backdrop-filter:blur(8px);border-bottom:1px solid #f0f0f0;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;max-width:var(--max-width);margin:0 auto;">
      <a href="https://invitea.github.io/home_page/" target="_blank" class="logo-link" aria-label="Ir a Invitéa">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:110px;height:32px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--map-btn));display:flex;align-items:center;justify-content:center;box-shadow:0 3px 8px var(--shadow);">
            <div style="color:white;font-family:'Montserrat',sans-serif;font-weight:700;font-size:15px;">Invitéa</div>
          </div>
        </div>
      </a>
      <div style="display:flex;gap:8px;">
        <a href="#" style="opacity:0.6;transition:opacity 0.2s;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent);"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
        <a href="#" style="opacity:0.6;transition:opacity 0.2s;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent);"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
      </div>
    </div>
  </header>

  <div class="invitation-container">
    <div class="header-section" role="banner">
      <div class="invitation-heading">Acompáñame a celebrar mi</div>
      <div class="event-title" aria-hidden="true">
        <span class="first-word">Primera Comunión</span>
      </div>

      <img class="communion-image" src="https://i.ibb.co/MyswS4v6/image.jpg" alt="Daniela en su Primera Comunión" loading="lazy" />
      <div class="child-name">Daniela Sanchez Perez</div>
    </div>

    <div class="content-section" role="main">
      <div class="event-date" id="dynamicDate" aria-label="Fecha del evento"></div>

      <div class="event-card" aria-labelledby="ceremonia">
        <div id="ceremonia" class="event-type">Ceremonia</div>
        <div class="event-time">13:00 hrs</div>
        <div class="event-location">Parroquia Nuestra Señora de Guadalupe<br/>Calle Cualquiera 123, Ciudad de México</div>
        <a class="map-button" href="https://www.google.com/maps/search/?api=1&query=Estrella%2038%2C%20San%20Juan%20Xalpa%2C%20Iztapalapa%2C%2009850%20Ciudad%20de%20M%C3%A9xico%2C%20CDMX" target="_blank">Cómo llegar</a>
      </div>

      <div class="event-card" aria-labelledby="recepcion">
        <div id="recepcion" class="event-type">Recepción</div>
        <div class="event-time">15:00 hrs</div>
        <div class="event-location">Salón de Fiestas "El Arca de los Niños"<br/>Calle Cualquiera 123, Ciudad de México</div>
        <a class="map-button" href="https://www.google.com/maps/search/?api=1&query=El%20Arca%20de%20los%20Ni%C3%B1os%2C%205%20de%20Mayo%20n%C3%BAm.%2031%2C%20Col.%20Los%20Reyes%20Culhuac%C3%A1n%2C%20Iztapalapa%2C%20Ciudad%20de%20M%C3%A9xico%2C%20CDMX" target="_blank">Cómo llegar</a>
      </div>

      <div class="event-card" aria-labelledby="regalos">
        <div id="regalos" class="event-type">Mesa de Regalos</div>
        <div class="event-location">Si deseas tener un detalle conmigo, puedes visitar mi mesa de regalos en Liverpool</div>
        <a class="gift-button" href="https://mesaderegalos.liverpool.com.mx/milistaderegalos" target="_blank">Ver Regalos</a>
      </div>

      <button class="confirm-button" id="openRsvp">Confirma asistencia</button>
    </div>

    <footer>
      <div class="footer-promo">
        <p>¿Te gustó esta invitación?</p>
        <a href="https://invitea.github.io/home_page/" target="_blank" class="btn-cotizar">
          <span style="font-size: 14px;">✨</span> DISEÑA TU EVENTO CON INVITÉA
        </a>
      </div>
      
      <div class="footer-copyright">
        © 2025 Invitea — Todos los derechos reservados<br/>
        Contacto · <a href="mailto:invitea.design@gmail.com">invitea.design@gmail.com</a>
      </div>
    </footer>
  </div>

  <div id="rsvpModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="close-modal" id="closeModalBtn">×</button>
      <div class="modal-title">Confirmar Asistencia</div>

      <form id="rsvpForm" novalidate>
        <div class="form-group">
          <label for="name" class="form-label">Nombre Completo</label>
          <input id="name" name="name" type="text" required placeholder="Escribe tu nombre" />
          <div class="error-message" id="nameError">Nombre requerido</div>
        </div>

        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input id="email" name="email" type="email" placeholder="ejemplo@correo.com" />
          <div class="error-message" id="emailError">Email inválido</div>
          <div class="warning-message" id="emailDuplicateError">Este correo ya confirmó</div>
        </div>

        <div class="form-group">
          <label for="phone" class="form-label">Teléfono</label>
          <input id="phone" name="phone" type="tel" placeholder="(00) 0000 0000" />
          <div class="error-message" id="phoneError">Teléfono inválido</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="form-group">
              <label for="adults" class="form-label">Adultos</label>
              <input id="adults" name="adults" type="number" min="1" value="1" required />
              <div class="error-message" id="adultsError">Min 1</div>
            </div>
            <div class="form-group">
              <label for="children" class="form-label">Niños</label>
              <input id="children" name="children" type="number" min="0" value="0" required />
              <div class="error-message" id="childrenError">No negativo</div>
            </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Enviar Confirmación</button>
        <div class="loading-spinner" id="loadingSpinner"></div>
      </form>

      <div id="thankYouMessage" class="success">¡Gracias por confirmar!</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCTh8kPdvu-6Z5_cckNts22VrhdUTLVspM",
      authDomain: "invitea-f7331.firebaseapp.com",
      projectId: "invitea-f7331",
      storageBucket: "invitea-f7331.firebasestorage.app",
      messagingSenderId: "145115727672",
      appId: "1:145115727672:web:d1d89c20bf946b9e2663cd",
      measurementId: "G-8JS1MDZVGQ"
    };

    function getDynamicDate() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      const dateString = tomorrow.toLocaleDateString('es-MX', options);
      return dateString.charAt(0).toUpperCase() + dateString.slice(1);
    }

    function preloadImage(url) {
      const img = new Image();
      img.src = url;
    }

    window.addEventListener('load', () => {
      preloadImage('https://i.ibb.co/MyswS4v6/image.jpg');
      const d = document.getElementById('dynamicDate');
      if (d) d.textContent = getDynamicDate();
      
      if (window.firebase && firebase.initializeApp) {
        try { firebase.initializeApp(firebaseConfig); window.db = firebase.firestore(); }
        catch(e) { console.warn('Firebase init:', e); }
      }
    });

    (function(){
      const openBtn = document.getElementById('openRsvp');
      const modal = document.getElementById('rsvpModal');
      const closeBtn = document.getElementById('closeModalBtn');
      const form = document.getElementById('rsvpForm');
      const submitBtn = document.getElementById('submitBtn');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const thankYou = document.getElementById('thankYouMessage');
      
      const nameIn = document.getElementById('name');
      const emailIn = document.getElementById('email');
      const phoneIn = document.getElementById('phone');
      const adultsIn = document.getElementById('adults');
      const childrenIn = document.getElementById('children');

      const nameErr = document.getElementById('nameError');
      const emailErr = document.getElementById('emailError');
      const emailDupErr = document.getElementById('emailDuplicateError');
      const phoneErr = document.getElementById('phoneError');
      const adErr = document.getElementById('adultsError');
      const chErr = document.getElementById('childrenError');

      function isValidEmail(e) { if(!e) return true; return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
      function isValidPhone(p) { if(!p) return true; return p.replace(/\D/g, '').length === 10; }
      function formatPhone(v) {
        const n = v.replace(/\D/g, '');
        if (n.length <= 2) return n;
        if (n.length <= 6) return `(${n.slice(0,2)}) ${n.slice(2)}`;
        return `(${n.slice(0,2)}) ${n.slice(2,6)}-${n.slice(6,10)}`;
      }

      async function checkEmail(e) {
        if(!e || !isValidEmail(e)) return false;
        try {
          const s = await db.collection('ejemploprimeracomunion_panel').where('email','==',e.toLowerCase().trim()).get();
          return !s.empty;
        } catch { return false; }
      }

      function showErr(i,e,m) { e.textContent=m; e.style.display='block'; i.classList.add('error'); }
      function clearErr(i,e) { e.style.display='none'; i.classList.remove('error','warning'); }

      phoneIn.addEventListener('input', (e) => {
        e.target.value = formatPhone(e.target.value);
        if(e.target.value && !isValidPhone(e.target.value)) showErr(phoneIn, phoneErr, '10 dígitos requeridos');
        else clearErr(phoneIn, phoneErr);
      });

      emailIn.addEventListener('blur', async (e) => {
        const val = e.target.value.trim();
        if(val && !isValidEmail(val)) { showErr(emailIn, emailErr, 'Email inválido'); emailDupErr.style.display='none'; return; }
        if(val) {
          const exists = await checkEmail(val);
          if(exists) { emailDupErr.style.display='block'; emailErr.style.display='none'; emailIn.classList.add('warning'); }
          else { clearErr(emailIn, emailErr); emailDupErr.style.display='none'; }
        } else { clearErr(emailIn, emailErr); emailDupErr.style.display='none'; }
      });

      function openModal() { modal.classList.add('active'); document.body.style.overflow='hidden'; setTimeout(()=>nameIn.focus(),100); }
      function closeModal() {
        modal.classList.remove('active'); document.body.style.overflow='';
        setTimeout(() => {
          thankYou.style.display='none'; form.style.display='block'; form.reset();
          adultsIn.value=1; childrenIn.value=0;
          [nameErr,emailErr,emailDupErr,phoneErr,adErr,chErr].forEach(e=>e.style.display='none');
          [nameIn,emailIn,phoneIn,adultsIn,childrenIn].forEach(i=>i.classList.remove('error','warning'));
          submitBtn.disabled=false; submitBtn.textContent='Enviar Confirmación'; loadingSpinner.style.display='none';
        }, 300);
      }

      openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!window.db) { alert('Error de conexión'); return; }
        
        let valid = true;
        if(nameIn.value.length < 3) { showErr(nameIn, nameErr, 'Nombre requerido'); valid=false; }
        const emVal = emailIn.value.trim();
        if(emVal && !isValidEmail(emVal)) { showErr(emailIn, emailErr, 'Email inválido'); valid=false; }
        else if(emVal && await checkEmail(emVal)) { emailDupErr.style.display='block'; valid=false; }
        if(phoneIn.value && !isValidPhone(phoneIn.value)) { showErr(phoneIn, phoneErr, 'Teléfono inválido'); valid=false; }
        if(adultsIn.value < 1) { showErr(adultsIn, adErr, 'Min 1'); valid=false; }
        if(childrenIn.value < 0) { showErr(childrenIn, chErr, 'No negativo'); valid=false; }

        if(!valid) return;

        submitBtn.disabled=true; submitBtn.textContent='Enviando...'; loadingSpinner.style.display='block';

        try {
          await db.collection('ejemploprimeracomunion_panel').add({
            nombre: nameIn.value.trim(),
            email: emVal || 'No proporcionado',
            telefono: phoneIn.value || 'No proporcionado',
            adultos: Number(adultsIn.value),
            ninos: Number(childrenIn.value),
            dispositivo: navigator.userAgent,
            pantalla: `${window.innerWidth}x${window.innerHeight}`,
            fecha: new Date().toLocaleString('es-MX'),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          form.style.display='none'; thankYou.style.display='block'; loadingSpinner.style.display='none';
          setTimeout(closeModal, 2000);
        } catch(err) {
          console.error(err); alert('Error al guardar');
          submitBtn.disabled=false; submitBtn.textContent='Enviar Confirmación'; loadingSpinner.style.display='none';
        }
      });
    })();
  </script>
</body>
</html>
